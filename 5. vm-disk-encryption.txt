




Powershell
----------



$loc =east-us
$rg =(New-AzResourceGroup -Name diskecn-into -Location $loc).ResourceGroupName
$cred = Get-Credential

#1. Create the new vm for the encryption

$vm =New-AzVM `
    -Name vmenc-dev `
    -Location $loc `
    -ResourceGroupName $rg `
    -VirtualNetworkName encvnet `
    -SubnetName encsubnet `
    -PublicIpAddressName encip `
    -Credential $cred `
    -OpenPorts 80,3389

#2. Create the new keyvault with diskencryption enabled

$kv = New-AzKeyVault `
        -Name encKeyvaultshu `
        -ResourceGroupName $rg `
        -Sku Standard `
        -Location $loc `
        -EnabledForDiskEncryption 

#3. Enable the disk encryption for the above created vm

Set-AzVMDiskEncryptionExtension `
        -ResourceGroupName $rg `
        -VMName $vm.Name `
        -DiskEncryptionKeyVaultUrl $kv.VaultUri `
        -DiskEncryptionKeyVaultId $kv.ResourceId 

#4. Varify the disk encryption status 
Get-AzVMDiskEncryptionStatus `
       -ResourceGroupName $rg `
       -VMName $vm.Name
